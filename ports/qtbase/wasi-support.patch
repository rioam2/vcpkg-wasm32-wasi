From 2b76521384482c32c96028eead1947d3c8b1f5fa Mon Sep 17 00:00:00 2001
From: Rio Martinez <rio.martinez@remarkable.com>
Date: Wed, 18 Jun 2025 17:07:49 +0200
Subject: [PATCH] chore: wasi support

This PR adds rudimentary WebAssembly/WASI support
by excluding unsupported calls to non-implemented
WASI/posix syscalls.

This also adds an OS definition for WASI in Qt.
---
 src/corelib/global/qsystemdetection.h                     | 2 ++
 src/plugins/platforms/offscreen/qoffscreenintegration.cpp | 2 +-
 2 files changed, 3 insertions(+), 1 deletion(-)

diff --git a/src/corelib/global/qsystemdetection.h b/src/corelib/global/qsystemdetection.h
index 0cbcef27407..0dfb4f0070a 100644
--- a/src/corelib/global/qsystemdetection.h
+++ b/src/corelib/global/qsystemdetection.h
@@ -130,6 +130,8 @@
 #elif defined(__HAIKU__)
 #  define Q_OS_HAIKU
 #elif defined(__MAKEDEPEND__)
+#elif defined(__wasi__)
+#  define Q_OS_WASI
 #else
 #  error "Qt has not been ported to this OS - see http://www.qt-project.org/"
 #endif
diff --git a/src/plugins/platforms/offscreen/qoffscreenintegration.cpp b/src/plugins/platforms/offscreen/qoffscreenintegration.cpp
index 5decacc61a3..1932b0b015f 100644
--- a/src/plugins/platforms/offscreen/qoffscreenintegration.cpp
+++ b/src/plugins/platforms/offscreen/qoffscreenintegration.cpp
@@ -341,7 +341,7 @@ QPlatformBackingStore *QOffscreenIntegration::createPlatformBackingStore(QWindow
 
 QAbstractEventDispatcher *QOffscreenIntegration::createEventDispatcher() const
 {
-#if defined(Q_OS_UNIX)
+#if defined(Q_OS_UNIX) && !defined(Q_OS_WASI)
     return createUnixEventDispatcher();
 #elif defined(Q_OS_WIN)
     return new QOffscreenEventDispatcher<QEventDispatcherWin32>();
-- 
2.39.5 (Apple Git-154)

